function generatePDFReport(patientData, diagnosisData) {
  // Check if jsPDF is available
  if (!window.jspdf || !window.jspdf.jsPDF) {
    console.error("jsPDF is not available");
    throw new Error("PDF library not loaded correctly");
  }
  
  // Initialize jsPDF (correct way)
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const pageWidth = doc.internal.pageSize.getWidth();

  // Header
  doc.setFontSize(22);
  doc.setTextColor(30, 126, 97);
  doc.text("Diagno+", pageWidth/2, 20, { align: "center" });
  doc.setFontSize(16);
  doc.text("Medical Diagnostic Report", pageWidth/2, 30, { align: "center" });

  // Decorative line
  doc.setDrawColor(30, 126, 97);
  doc.setLineWidth(0.5);
  doc.line(20, 35, pageWidth-20, 35);

  // Patient Information
  doc.setFontSize(12);
  doc.setTextColor(0, 0, 0);
  doc.text("PATIENT INFORMATION", 20, 45);
  doc.setFontSize(10);
  doc.text(`Name: ${patientData.name}`, 20, 55);
  doc.text(`Patient ID: ${patientData.patientId}`, 20, 62);
  doc.text(`Age: ${patientData.age}`, 20, 69);
  doc.text(`Report Date: ${new Date().toLocaleDateString()}`, 20, 76);

  // Diagnosis Result
  doc.setFontSize(12);
  doc.text("DIAGNOSIS RESULT", 20, 90);
  doc.setFontSize(10);
  doc.text(`Test Type: ${diagnosisData.testType}`, 20, 100);
  doc.text(`Diagnosis: ${diagnosisData.prediction}`, 20, 107);
  doc.text(`Confidence: ${diagnosisData.confidence}%`, 20, 114);

  // Condition Information
  doc.setFontSize(12);
  doc.text("CONDITION INFORMATION", 20, 130);
  doc.setFontSize(9);

  const metadata = diagnosisData.metadata || "No additional information available.";
  const splitMetadata = doc.splitTextToSize(metadata, pageWidth - 40);
  doc.text(splitMetadata, 20, 140);

  // Add visualization image if available
  if (diagnosisData.visualizationImage) {
    try {
      const imgHeight = 80;
      let yPosition = 160 + splitMetadata.length * 5; 

      // Add new page if needed
      if (yPosition + imgHeight > doc.internal.pageSize.getHeight() - 20) {
        doc.addPage();
        yPosition = 30;
      }

      doc.text("DIAGNOSTIC VISUALIZATION", 20, yPosition - 10);
      doc.addImage(diagnosisData.visualizationImage, 'PNG', 20, yPosition, 170, imgHeight);
    } catch (imgError) {
      console.error("Error adding image to PDF:", imgError);
      doc.text("Image visualization unavailable", 20, 160);
    }
  }

  // Footer
  const footerY = doc.internal.pageSize.getHeight() - 10;
  doc.setFontSize(8);
  doc.setTextColor(100, 100, 100);
  doc.text("This report is generated by AI and should be reviewed by a healthcare professional.", pageWidth/2, footerY, { align: "center" });

  return doc;
}

// Expose the function globally
window.generatePDFReport = generatePDFReport;
